# Анализ медицинских данных

## Описание задачи
Разработка аналитической системы для эпидемиологического мониторинга COVID-19 на основе метаданных рентгеновских снимков с использованием PySpark и SQL-аналитики.

## Инструкция по запуску
1. Создать окружения: **macOS/Linux** - `python3 -m venv .venv`; **Windows** - `python -m venv .venv`
2. Установите зависимости: `pip install -r requirements.txt`
3. Установите Java на Linux: 
    ```bash
    sudo apt install openjdk-17-jdk-headless -y
    export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
    echo "export JAVA_HOME=$JAVA_HOME" >> ~/.bashrc
    ```
2. Загрузите файл `metadata.csv` в корневую директорию проекта
3. Запустите Jupyter Notebook: `jupyter notebook analysis.ipynb`
4. Выполните ячейки последовательно

## Структура проекта
```
project/
├── .gitignore              # Исключения для git
├── analysis.ipynb          # Основной ноутбук с анализом
├── metadata.csv            # Исходные данные (Нужно добавить)
├── presentation.pdf        # Презентация
├── processed_data/         # Результаты обработки (Parquet)
├── requirements.txt        # Файлы с зависимостями для Python
│   ├── df/                 # Основной обработанный датасет
│   ├── pneumonia_over_50/  # Пациенты с пневмонией >50 лет
│   └── complete_clinical_data/ # Полные клинические данные
└── README.md               # Документация
```

## Этапы работы в analysis.ipynb

### 1. Инициализация и загрузка данных
- Создание Spark сессии с оптимизациями (Spark 4.0.1, Java 17)
- Загрузка `metadata.csv` (950 записей, 29 столбцов) с парсингом дат в разных форматах
- Удаление лишнего столбца `_c29`

### 2. Предобработка данных
- Анализ пропусков по всем полям: survival - 62%, лабораторные показатели - 95-98%, ICU статус - 58-96%
- Заполнение пропусков в поле `survival` на основе медицинских критериев (тяжелые случаи → "N", легкие → "Y")
- Итоговое распределение выживаемости: 80.6% выживших (767), 19.4% умерших (183)
- Создание категорий заболеваний: Pneumonia, Tuberculosis, No Finding, ToDo, Unknown
- Обработка возраста: фильтрация некорректных значений (18-94 лет после очистки)
- Удаление дубликатов: устранено 291 повторяющаяся запись

### 3. Анализ качества данных
- Построение распределения пропусков по всем полям (визуализация: bar chart)
- Выявление аномалий в числовых полях: минимальное количество выбросов (>3σ), экстремальные значения в lymphocyte_count (131.0) и pO2_saturation (340.0)
- Визуализация: bar chart (проценты пропусков) и boxplot (распределение значений)

### 4. SQL-аналитика
- **Запрос 1**: Базовая статистика по диагнозам (Pneumonia: 594 случаев, ToDo: 27, No Finding: 20, Tuberculosis: 17, Unknown: 1)
- **Запрос 2**: Распределение по полу и диагнозам (преобладание мужчин в Pneumonia: 347 мужчин vs 186 женщин)
- **Запрос 3**: Топ-3 по возрасту в каждой группе диагнозов (максимальный возраст: 94 года в Pneumonia)
- **Запрос 4**: Временные тренды (пик в 2020 году - 302 случая Pneumonia, что соответствует периоду пандемии)
- **Запрос 5**: Статистика по проекциям снимков (преобладание PA - 228 случаев и AP - 141 случай для Pneumonia)
- **Дополнительно**: Статистика по выживаемости для пневмонии (Viral pneumonia: 303 случая без данных о выживаемости)

### 5. Расширенная обработка в PySpark
- Создание UDF для категоризации возраста (Child, Young Adult, Adult, Middle Aged, Senior)
- Создание UDF для унификации диагнозов (COVID-19, Viral Pneumonia, Bacterial Pneumonia, Fungal Pneumonia и т.д.)
- Фильтрация данных:
  - Пневмония у пациентов >50 лет: 77 случаев (Middle Aged + Senior)
  - Полные клинические данные (возраст+пол+диагноз): 504 случая
- Сохранение результатов в формате Parquet с компрессией snappy:
  - Основной датасет: `processed_data/df` (659 записей после обработки)
  - Пневмония >50 лет: `processed_data/pneumonia_over_50`
  - Полные клинические данные: `processed_data/complete_clinical_data`

## Выводы

**1. Качество данных**: Критические поля (survival, ICU статус, лабораторные показатели) имеют высокий процент пропусков (58-98%), что ограничивает анализ выживаемости.

**2. Распределение диагнозов**: Большинство случаев (594) классифицированы как "Pneumonia", что указывает на фокус исследования респираторных заболеваний.

**3. Демография**: Преобладание мужчин среди пациентов с пневмонией (347 мужчин vs 186 женщин), средний возраст пациентов - 53.5 года.

**4. Временные тренды**: Пик исследований в 2020 году (302 случая пневмонии), что соответствует периоду пандемии COVID-19.

**5. Технические результаты**: Данные успешно обработаны, созданы структурированные датасеты для дальнейшего анализа (пациенты с пневмонией >50 лет: 77 случаев, полные клинические данные: 504 случая), реализована полная цепочка ETL в PySpark.